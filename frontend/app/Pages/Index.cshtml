@page "/"
@model app.Pages.IndexModel
@{
    ViewData["Title"] = "SQLBot - Home";
}

<!DOCTYPE html>
<html>
<head>
    <title>SQLBot - Home</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; }
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #f3f4f6;
            color: #111827;
        }

        /* Navbar - 50px fixo */
        #navbar {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: #111827;
            color: #ffffff;
            flex-shrink: 0;
        }
        #navbar > div:first-child { font-weight: 700; }
        #navbar > div:last-child { text-align: right; align-items: center; display: flex; gap: 12px; }
        #navbar form { margin: 0; }
        #navbar button {
            background: #374151;
            color: #fff;
            border: 1px solid #4b5563;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        #navbar button:hover { background: #4b5563; }

        /* Área principal entre navbar e input/footer */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #ffffff;
            padding: 0;
            height: 100%;
            padding-bottom: 183px;
        }

        /* Abas */
        #tabs { display: flex; gap: 8px; border-bottom: 1px solid #e5e7eb; padding: 12px 16px 6px 16px; flex-shrink: 0; }
        #tabs button {
            background: transparent;
            border: 0;
            padding: 10px 12px;
            cursor: pointer;
            color: #374151;
            font-weight: 600;
            border-bottom: 2px solid transparent;
        }
        #tabs button:hover { color: #111827; }
        #tabs button[data-active="true"] { color: #111827; border-bottom-color: #111827; }

        /* Painéis */
        #chat, #dashboard { flex: 1; display: none; flex-direction: column; overflow: hidden; background: #ffffff; padding: 16px; }
        #chat[style*="flex"], #dashboard[style*="flex"] { display: flex; }

        /* Chat */
        #chatMessages { flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        #chatMessages > div { background: #e5e7eb; color: #111827; padding: 10px 14px; border-radius: 8px; word-wrap: break-word; white-space: pre-wrap; overflow-wrap: break-word; max-width: 75%; line-height: 1.5; }
        #chatMessages > div.user-message { align-self: flex-end; background: #374151; color: #fff; }
        #chatMessages > div.bot-message { align-self: flex-start; background: #e5e7eb; }
        
        /* Formatação dentro das mensagens */
        #chatMessages p { margin: 0; }
        #chatMessages ul { margin: 8px 0 8px 20px; padding: 0; }
        #chatMessages li { margin: 4px 0; list-style-type: disc; }
        #chatMessages h4 { margin: 12px 0 8px 0; font-size: 14px; font-weight: 600; }
        #chatMessages strong { font-weight: 600; }
        #chatMessages em { font-style: italic; }
        #chatLoading { text-align: center; color: #6b7280; padding: 8px; display: none; font-size: 14px; }
        #chatLoading[style*="block"] { display: block; }

        /* Dashboard */
        #dashboard { overflow-y: auto; }
        #dashboard h2 { font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #111827; }
        #dashboardLoading { text-align: center; color: #6b7280; padding: 8px; display: none; }
        #dashboardLoading[style*="block"] { display: block; }
        table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #e5e7eb; }
        table th, table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        table th { background: #f9fafb; font-weight: 600; color: #111827; }
        table button { padding: 6px 10px; border: 0; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; margin-right: 6px; }
        table button:first-of-type { background: #111827; color: #fff; }
        table button:last-of-type { background: #b91c1c; color: #fff; }
        table button:first-of-type:hover { background: #1f2937; }
        table button:last-of-type:hover { background: #991b1b; }

        /* Input fixo embaixo - só aparece no chat */
        #chatInputBar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            height: auto;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            z-index: 100;
            justify-content: center;
            align-items: flex-end;
            gap: 12px;
        }
        #chatInputBar.show { display: flex; }
        
        #chatInput { 
            flex: 0 0 auto;
            min-width: 400px;
            width: 500px;
            min-height: 50px; 
            max-height: 150px; 
            resize: vertical; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            padding: 12px; 
            font-family: inherit; 
            font-size: 15px; 
            background: #fff; 
        }
        #chatInput:focus { outline: none; border-color: #111827; box-shadow: 0 0 0 3px rgba(17,24,39,0.1); }
        
        #chatSendBtn { 
            padding: 12px 24px; 
            background: #111827; 
            color: #fff; 
            border: 0; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            flex-shrink: 0; 
            height: 50px;
            display: flex;
            align-items: center;
        }
        #chatSendBtn:hover { background: #1f2937; }
    </style>
</head>
<body>
    <div id="navbar">
        <div>🤖 SQLBot</div>
        <div>
            <div>Usuário: @Model.UserEmail</div>
            <form method="post" style="margin: 0;">
                <button type="submit" name="action" value="logout">Sair</button>
            </form>
        </div>
    </div>
    
    <div id="main">
        <div id="tabs">
            <button data-tab="chat" onclick="openTab(event, 'chat')">💬 Chat</button>
            @if (Model.IsAdmin)
            {
                <button data-tab="dashboard" onclick="openTab(event, 'dashboard')">📊 Dashboard</button>
            }
        </div>
        
        <!-- Chat Tab -->
        <div id="chat">
            @if (!string.IsNullOrEmpty(Model.ChatError))
            {
                <div>@Model.ChatError</div>
            }
            
            <div id="chatMessages">
<div class="bot-message"><strong>Bot:</strong> Diga seu problema em apenas uma mensagem!</div>
            </div>
            
            <div id="chatLoading">Aguardando resposta...</div>
        </div>
        
        <!-- Dashboard Tab -->
        @if (Model.IsAdmin)
        {
            <div id="dashboard">
                @if (!string.IsNullOrEmpty(Model.DashboardError))
                {
                    <div>@Model.DashboardError</div>
                }
                
                <h2>Gerenciamento de Usuários</h2>
                
                <div id="dashboardLoading">Carregando usuários...</div>
                
                <table id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Papel</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                    </tbody>
                </table>
            </div>
        }
    </div>
    
    <!-- Input fixo para chat -->
    <div id="chatInputBar">
        <textarea id="chatInput" placeholder="Digite sua mensagem..."></textarea>
        <button id="chatSendBtn" onclick="sendMessage()">Enviar</button>
    </div>
    
    <script>
        // Configuração de URL do Backend - pode ser alterada via variável de ambiente
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:6660'
            : 'http://' + window.location.hostname + ':6660';
        
        const isAdmin = @(Model.IsAdmin ? "true" : "false");

        // Ativa uma aba e sincroniza o estado
        function setActiveTab(tabName) {
            // Remove active de todos os painéis de conteúdo
            const panels = document.querySelectorAll('#chat, #dashboard');
            panels.forEach(p => p.style.display = 'none');
            
            // Remove active de todos os botões
            const buttons = document.querySelectorAll('[data-tab]');
            buttons.forEach(b => { b.style.fontWeight = 'normal'; b.removeAttribute('data-active'); });
            
            // Ativa o painel correto
            const panel = document.getElementById(tabName);
            if (panel) panel.style.display = 'flex';
            
            // Ativa o botão correto
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) { btn.style.fontWeight = 'bold'; btn.setAttribute('data-active', 'true'); }
            
            // Mostra/esconde input bar baseado na aba
            const inputBar = document.getElementById('chatInputBar');
            if (tabName === 'chat') {
                inputBar.classList.add('show');
            } else {
                inputBar.classList.remove('show');
            }
            
            // Se for dashboard, carrega os usuários
            if (tabName === 'dashboard') {
                loadUsers();
            }
        }

        // Handler dos botões das abas
        function openTab(evt, tabName) {
            evt.preventDefault();
            setActiveTab(tabName);
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message';
            userMessageDiv.innerHTML = '<strong>Você:</strong> ' + escapeHtml(message);
            chatMessages.appendChild(userMessageDiv);
            
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            document.getElementById('chatLoading').style.display = 'block';
            
            // Chamar diretamente o backend em vez do handler Razor
            fetch(API_BASE_URL + '/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(async (response) => {
                const text = await response.text();
                console.log('Response status:', response.status, 'Body:', text);
                let data;
                try {
                    data = text ? JSON.parse(text) : {};
                } catch (e) {
                    throw new Error(text || `HTTP ${response.status}`);
                }
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                return data;
            })
            .then(data => {
                document.getElementById('chatLoading').style.display = 'none';
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'bot-message';
                const formattedResponse = formatMarkdown(data.response || 'Erro ao obter resposta');
                botMessageDiv.innerHTML = '<strong>Bot:</strong> ' + formattedResponse;
                chatMessages.appendChild(botMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                document.getElementById('chatLoading').style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bot-message';
                errorDiv.innerHTML = '<strong>Bot:</strong> Erro: ' + escapeHtml(error.message);
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function formatMarkdown(text) {
            if (!text) return '';
            
            // Escapar HTML perigoso mas manter quebras de linha
            text = text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
            
            // Converter quebras de linha para <br>
            text = text.replace(/\n\n/g, '</p><p>')
                      .replace(/\n/g, '<br>');
            
            // Converter listas markdown simples (- item)
            text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
            
            // Envolve listas em <ul>
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Converter **negrito**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Converter *itálico*
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Converter números em títulos (1. título → <h4>título</h4>)
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<h4>$2</h4>');
            
            // Envolver em parágrafos se não tiver tags de bloco
            if (!text.includes('<p>') && !text.includes('<ul>') && !text.includes('<h4>')) {
                text = '<p>' + text + '</p>';
            }
            
            return text;
        }
        
        function loadUsers() {
            const loading = document.getElementById('dashboardLoading');
            const table = document.getElementById('usersTable');
            const tbody = document.getElementById('usersBody');
            
            loading.style.display = 'block';
            
            // Chamar diretamente a API do backend
            fetch(API_BASE_URL + '/api/users')
            .then(async (response) => {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`Erro ao carregar usuários: ${response.status}`);
                }
            })
            .then(data => {
                loading.style.display = 'none';
                tbody.innerHTML = '';
                
                // Se for um array direto, usar como está
                const users = Array.isArray(data) ? data : (data.users || []);
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>
                            <button onclick="editUser(${user.id})">Editar</button>
                            <button onclick="deleteUser(${user.id})">Deletar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'table';
            })
            .catch(error => {
                loading.style.display = 'none';
                alert('Erro ao carregar usuários: ' + error.message);
            });
        }
        
        function deleteUser(userId) {
            if (confirm('Tem certeza que deseja deletar este usuário?')) {
                fetch(API_BASE_URL + '/api/users/' + userId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(async (response) => {
                    if (response.ok) {
                        loadUsers();
                    } else {
                        throw new Error(`Erro ao deletar: HTTP ${response.status}`);
                    }
                })
                .catch(error => {
                    alert('Erro ao deletar usuário: ' + error.message);
                });
            }
        }
        
        function editUser(userId) {
            alert('Funcionalidade de edição em desenvolvimento');
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Permitir enviar mensagem com Ctrl+Enter (Enter normal permite quebra de linha)
        document.getElementById('chatInput')?.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Abre a aba de chat por padrão ao carregar
        function initializeApp() {
            setActiveTab('chat');
        }
        
        // Executar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
